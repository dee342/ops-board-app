<!DOCTYPE html><html lang="en"><head><title>public\scripts\services\task-helper-service</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../../"><meta name="groc-document-path" content="public\scripts\services\task-helper-service"><meta name="groc-project-path" content="public\scripts\services\task-helper-service.js"><link rel="stylesheet" type="text/css" media="all" href="../../../assets/style.css"><script type="text/javascript" src="../../../assets/behavior.js"></script><body><div id="meta"><div class="file-path">public\scripts\services\task-helper-service.js</div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-pi">'use strict'</span>;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This file contains all the logic for working with Tasks, including creating
commands, processing server commands, formatting and manipulating task data.</p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Section - Create Commands for Server - Start </p></div></div><div class="code"><div class="wrapper">angular
    .module(<span class="hljs-string">'OpsBoard'</span>)
    .service(
        <span class="hljs-string">'TaskHelperService'</span>,
        <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(EquipmentHelperService, PersonnelHelperService, InfoService)</span> </span>{

          <span class="hljs-keyword">var</span> findTask = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(taskKey, data, onlyKeyRing)</span> </span>{
            <span class="hljs-keyword">var</span> task, keyRing = {};
            <span class="hljs-built_in">Object</span>
                .keys(data.locations)
                .forEach(
                    <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key)</span> </span>{
                      <span class="hljs-keyword">if</span> (data.locations[key].locationShifts) {
                        <span class="hljs-built_in">Object</span>
                            .keys(data.locations[key].locationShifts)
                            .forEach(
                                <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(shiftId)</span> </span>{
                                  <span class="hljs-keyword">if</span> (data.locations[key].locationShifts[shiftId].shiftCategories) {
                                    <span class="hljs-built_in">Object</span>
                                        .keys(data.locations[key].locationShifts[shiftId].shiftCategories)
                                        .forEach(
                                            <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(categoryId)</span> </span>{
                                              <span class="hljs-keyword">if</span> (data.locations[key].locationShifts[shiftId].shiftCategories[categoryId].subcategoryTasks) {
                                                <span class="hljs-keyword">var</span> subs = data.locations[key].locationShifts[shiftId].shiftCategories[categoryId].subcategoryTasks;
                                                <span class="hljs-built_in">Object</span>
                                                    .keys(subs)
                                                    .forEach(
                                                        <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(subId)</span> </span>{
                                                          <span class="hljs-keyword">if</span> (subs[subId].subcategory.containsSections) {
                                                            <span class="hljs-built_in">Object</span>
                                                                .keys(subs[subId].sections)
                                                                .forEach(
                                                                    <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(sectionId)</span> </span>{
                                                                      <span class="hljs-keyword">if</span> (subs[subId].sections[sectionId]) {
                                                                        <span class="hljs-built_in">Object</span>
                                                                            .keys(subs[subId].sections[sectionId].tasks)
                                                                            .forEach(
                                                                                <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(taskId)</span> </span>{
                                                                                  <span class="hljs-keyword">if</span> (taskId == taskKey) {
                                                                                    task = subs[subId].sections[sectionId].tasks[taskId];
                                                                                    <span class="hljs-keyword">if</span> (onlyKeyRing) {
                                                                                      keyRing = {
                                                                                        locationId : key,
                                                                                        locationShiftId : shiftId,
                                                                                        shiftCategoryId : categoryId,
                                                                                        subcategoryTaskId : subId,
                                                                                        sectionId : sectionId,
                                                                                        containsSections : <span class="hljs-literal">true</span>,
                                                                                        peoplePerTask : subs[subId].subcategory.peoplePerTask,
                                                                                        taskId : taskId,
                                                                                        linkedTaskChildId : task.linkedTaskChildId,
                                                                                        linkedTaskParentId : task.linkedTaskParentId
                                                                                      }
                                                                                    }
                                                                                  }
                                                                                })
                                                                      }
                                                                    })
                                                          } <span class="hljs-keyword">else</span> {
                                                            <span class="hljs-built_in">Object</span>
                                                                .keys(subs[subId].tasks)
                                                                .forEach(
                                                                    <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(taskId)</span> </span>{
                                                                      <span class="hljs-keyword">if</span> (taskId == taskKey) {
                                                                        task = subs[subId].tasks[taskId];
                                                                        <span class="hljs-keyword">if</span> (onlyKeyRing) {
                                                                          keyRing = {
                                                                            locationId : key,
                                                                            locationShiftId : shiftId,
                                                                            shiftCategoryId : categoryId,
                                                                            subcategoryTaskId : subId,
                                                                            containsSections : <span class="hljs-literal">false</span>,
                                                                            peoplePerTask : subs[subId].subcategory.peoplePerTask,
                                                                            taskId : taskId,
                                                                            linkedTaskChildId : task.linkedTaskChildId,
                                                                            linkedTaskParentId : task.linkedTaskParentId
                                                                          }
                                                                        }
                                                                      }
                                                                    })
                                                          }
                                                        })
                                              }
                                            })
                                  }
                                })
                      }
                    })
            <span class="hljs-keyword">if</span> (onlyKeyRing)
              <span class="hljs-keyword">return</span> keyRing
            <span class="hljs-keyword">return</span> task;
          }

          <span class="hljs-keyword">var</span> findSection = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(sectionKey, data)</span> </span>{
            <span class="hljs-keyword">var</span> section;
            <span class="hljs-built_in">Object</span>
                .keys(data.locations)
                .forEach(
                    <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key)</span> </span>{
                      <span class="hljs-keyword">if</span> (data.locations[key].locationShifts) {
                        <span class="hljs-built_in">Object</span>
                            .keys(data.locations[key].locationShifts)
                            .forEach(
                                <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(shiftId)</span> </span>{
                                  <span class="hljs-keyword">if</span> (data.locations[key].locationShifts[shiftId].shiftCategories) {
                                    <span class="hljs-built_in">Object</span>
                                        .keys(data.locations[key].locationShifts[shiftId].shiftCategories)
                                        .forEach(
                                            <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(categoryId)</span> </span>{
                                              <span class="hljs-keyword">if</span> (data.locations[key].locationShifts[shiftId].shiftCategories[categoryId].subcategoryTasks) {
                                                <span class="hljs-keyword">var</span> subs = data.locations[key].locationShifts[shiftId].shiftCategories[categoryId].subcategoryTasks;
                                                <span class="hljs-built_in">Object</span>.keys(subs).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(subId)</span> </span>{
                                                  <span class="hljs-keyword">if</span> (subs[subId].subcategory.containsSections) {
                                                    <span class="hljs-built_in">Object</span>.keys(subs[subId].sections).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(sectionId)</span> </span>{
                                                      <span class="hljs-keyword">if</span> (sectionId === sectionKey) {
                                                        section = subs[subId].sections[sectionId];
                                                      }
                                                    })
                                                  }
                                                })
                                              }
                                            })
                                  }
                                })
                      }
                    })
            <span class="hljs-keyword">return</span> section;
          }

          <span class="hljs-keyword">var</span> hasTasks = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span> </span>{
            <span class="hljs-keyword">var</span> contains = <span class="hljs-literal">false</span>;
            <span class="hljs-built_in">Object</span>
                .keys(data.locations)
                .forEach(
                    <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key)</span> </span>{
                      <span class="hljs-keyword">if</span> (data.locations[key].locationShifts) {
                        <span class="hljs-built_in">Object</span>
                            .keys(data.locations[key].locationShifts)
                            .forEach(
                                <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(shiftId)</span> </span>{
                                  <span class="hljs-keyword">if</span> (data.locations[key].locationShifts[shiftId].shiftCategories) {
                                    <span class="hljs-built_in">Object</span>
                                        .keys(data.locations[key].locationShifts[shiftId].shiftCategories)
                                        .forEach(
                                            <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(categoryId)</span> </span>{
                                              <span class="hljs-keyword">if</span> (data.locations[key].locationShifts[shiftId].shiftCategories[categoryId].subcategoryTasks) {
                                                <span class="hljs-keyword">var</span> subs = data.locations[key].locationShifts[shiftId].shiftCategories[categoryId].subcategoryTasks;
                                                <span class="hljs-built_in">Object</span>
                                                    .keys(subs)
                                                    .forEach(
                                                        <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(subId)</span> </span>{
                                                          <span class="hljs-keyword">if</span> (subs[subId].subcategory.containsSections) {
                                                            <span class="hljs-built_in">Object</span>
                                                                .keys(subs[subId].sections)
                                                                .forEach(
                                                                    <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(sectionId)</span> </span>{
                                                                      <span class="hljs-keyword">if</span> (subs[subId].sections[sectionId]) {
                                                                        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Object</span>
                                                                            .keys(subs[subId].sections[sectionId].tasks).length &gt; <span class="hljs-number">0</span>) {
                                                                          contains = <span class="hljs-literal">true</span>;
                                                                          <span class="hljs-keyword">return</span>;
                                                                        }
                                                                      }
                                                                    })
                                                          } <span class="hljs-keyword">else</span> {
                                                            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Object</span>.keys(subs[subId].tasks).length &gt; <span class="hljs-number">0</span>) {
                                                              contains = <span class="hljs-literal">true</span>;
                                                              <span class="hljs-keyword">return</span>;
                                                            }
                                                          }
                                                        })
                                              }
                                            })
                                  }
                                })
                      }
                    })

            <span class="hljs-keyword">return</span> contains;
          }

          <span class="hljs-keyword">var</span> processErrorInEquipmentToTaskCommand = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(user, equipment, personnel, tasks, states, command,
              rootScope, browserUniqueId)</span> </span>{

            <span class="hljs-keyword">var</span> equipmentId = command.commandContent.command.equipmentId;
            <span class="hljs-keyword">var</span> task = findTask(command.commandContent.command.taskId, tasks);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>alert(command.commandContent.errorCode);</p></div></div><div class="code"><div class="wrapper">            <span class="hljs-keyword">switch</span> (command.commandContent.errorCode) {

              <span class="hljs-keyword">case</span> <span class="hljs-number">30029</span>: <span class="hljs-comment">// Task not found, should we delete task on the front</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>end?</p></div></div><div class="code"><div class="wrapper">                equipment[equipmentId].assigned = <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">if</span> (task != <span class="hljs-literal">null</span>)
                  task.assignedEquipment.equipment = <span class="hljs-literal">null</span>;
                <span class="hljs-keyword">break</span>;
              <span class="hljs-keyword">case</span> <span class="hljs-number">30001</span>: <span class="hljs-comment">// Equipment not found, should we delete the equipment</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>on front end?</p></div></div><div class="code"><div class="wrapper">                <span class="hljs-keyword">if</span> (equipment[equipmentId] != <span class="hljs-literal">null</span>)
                  equipment[equipmentId].assigned = <span class="hljs-literal">false</span>;
                task.assignedEquipment.equipment = <span class="hljs-literal">null</span>;
                <span class="hljs-keyword">break</span>;
              <span class="hljs-keyword">case</span> <span class="hljs-number">30005</span>: <span class="hljs-comment">// Task has equipment already assigned to it</span>
                equipment[equipmentId].assigned = <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">break</span>;
              <span class="hljs-keyword">case</span> <span class="hljs-number">30003</span>: <span class="hljs-comment">// Equipment is not available for assignment</span>
                task.assignedEquipment.equipment = <span class="hljs-literal">null</span>;
                <span class="hljs-keyword">break</span>;
            }
            <span class="hljs-keyword">if</span> (user.username !== command.user)
              rootScope.pushedId = equipmentId;
          }

          <span class="hljs-keyword">var</span> processErrorInPersonToTaskCommand = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(user, equipment, personnel, tasks, states, command,
              rootScope, browserUniqueId)</span> </span>{

            <span class="hljs-keyword">var</span> personId = command.commandContent.command.personId, position = command.commandContent.command.position;
            <span class="hljs-keyword">var</span> task = findTask(command.commandContent.command.taskId, tasks);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>alert(command.commandContent.errorCode);</p></div></div><div class="code"><div class="wrapper">            <span class="hljs-keyword">switch</span> (command.commandContent.errorCode) {
              <span class="hljs-keyword">case</span> <span class="hljs-number">30029</span>: <span class="hljs-comment">// Task not found</span>
                personnel[personId].assigned = <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">if</span> (task != <span class="hljs-literal">null</span>) {
                  <span class="hljs-keyword">if</span> (position == <span class="hljs-number">1</span>)
                    task.assignedPerson1.person = <span class="hljs-literal">null</span>;
                  <span class="hljs-keyword">if</span> (position == <span class="hljs-number">2</span>)
                    task.assignedPerson2.person = <span class="hljs-literal">null</span>;
                }
                <span class="hljs-keyword">break</span>;
              <span class="hljs-keyword">case</span> <span class="hljs-number">30002</span>: <span class="hljs-comment">// Person not found</span>
                <span class="hljs-keyword">if</span> (personnel[personId] != <span class="hljs-literal">null</span>)
                  personnel[personId].assigned = <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">if</span> (position == <span class="hljs-number">1</span>)
                  task.assignedPerson1.person = <span class="hljs-literal">null</span>;
                <span class="hljs-keyword">if</span> (position == <span class="hljs-number">2</span>)
                  task.assignedPerson2.person = <span class="hljs-literal">null</span>;
                <span class="hljs-keyword">break</span>;
              <span class="hljs-keyword">case</span> <span class="hljs-number">30006</span>: <span class="hljs-comment">// Task has person already assigned to it</span>
                personnel[personId].assigned = command.commandContent.command.assigned;
                <span class="hljs-keyword">break</span>;
              <span class="hljs-keyword">case</span> <span class="hljs-number">30039</span>: <span class="hljs-comment">// Person is not available for next day assignment</span>
                <span class="hljs-keyword">if</span> (position == <span class="hljs-number">1</span>)
                  task.assignedPerson1.person = <span class="hljs-literal">null</span>;
                <span class="hljs-keyword">if</span> (position == <span class="hljs-number">2</span>)
                  task.assignedPerson2.person = <span class="hljs-literal">null</span>;
                <span class="hljs-keyword">break</span>;
            }
            <span class="hljs-keyword">if</span> (user.username !== command.user)
              root_scope.pushedId = personId;
          }

          <span class="hljs-keyword">var</span> padEndofArray = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(array, desiredSize, element)</span> </span>{
            <span class="hljs-keyword">var</span> l = array.length;

            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = l; i &lt; desiredSize - l; i++) {
              array[i] = element;
            }

            <span class="hljs-keyword">return</span>;
          }

          <span class="hljs-keyword">return</span> {

            constructTaskCommand : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(commandName, clientSequence, boardLocation, boardDate, taskKey)</span> </span>{

              <span class="hljs-keyword">var</span> command = {
                <span class="hljs-string">'commandName'</span> : commandName,
                <span class="hljs-string">'clientSequence'</span> : clientSequence++,
                <span class="hljs-string">'commandContent'</span> : {
                  <span class="hljs-string">'taskId'</span> : taskKey
                },
                <span class="hljs-string">'date'</span> : boardDate,
                <span class="hljs-string">'location'</span> : boardLocation
              }

              <span class="hljs-keyword">return</span> command;
            },

            containsTasks : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(tasks)</span> </span>{
              <span class="hljs-keyword">return</span> hasTasks(tasks);
            },</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Section - Perform operations on server - Start </p></div></div><div class="code"><div class="wrapper">            createAssignEquipmentToPartialTaskCommand : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(states, clientSequence, boardLocation, boardDate,
                tasks, taskMap, task, pieceOfEquipment, locationId)</span> </span>{

              <span class="hljs-keyword">var</span> subcategoryTaskId, index = -<span class="hljs-number">1</span>;
              <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; taskMap.length; i++) {
                <span class="hljs-keyword">if</span> (taskMap[i].taskId === task.id) {
                  subcategoryTaskId = taskMap[i].subcategoryTaskId;
                  index = i;
                }
              }
              <span class="hljs-keyword">var</span> homogeneous = <span class="hljs-literal">true</span>;
              <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; taskMap.length; i++) {
                <span class="hljs-keyword">if</span> (taskMap[i].groupId === task.groupId)
                  <span class="hljs-keyword">if</span> (taskMap[i].subcategoryTaskId !== subcategoryTaskId)
                    homogeneous = <span class="hljs-literal">false</span>;
              }

              <span class="hljs-keyword">if</span> (homogeneous) {
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; taskMap.length; i++) {
                  <span class="hljs-keyword">if</span> (taskMap[i].groupId === task.groupId) { <span class="hljs-comment">// will change</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>this late to
push it to
array</p></div></div><div class="code"><div class="wrapper">                    <span class="hljs-keyword">var</span> category = tasks.locations[taskMap[i].locationId].locationShifts[taskMap[i].locationShiftId].shiftCategories[taskMap[i].shiftCategoryId], subcategory = category.subcategoryTasks[taskMap[i].subcategoryTaskId], task;
                    <span class="hljs-keyword">if</span> (subcategory.subcategory.containsSections)
                      task = subcategory.sections[taskMap[i].sectionId].tasks[taskMap[i].taskId]
                    <span class="hljs-keyword">else</span>
                      task = subcategory.tasks[taskMap[i].taskId]
                    task.assignedEquipment.equipment = pieceOfEquipment;
                    task.homogeneous = <span class="hljs-literal">true</span>;
                  }
                }
              } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">var</span> category = tasks.locations[taskMap[index].locationId].locationShifts[taskMap[index].locationShiftId].shiftCategories[taskMap[index].shiftCategoryId], subcategory = category.subcategoryTasks[taskMap[index].subcategoryTaskId], task;
                <span class="hljs-keyword">if</span> (subcategory.subcategory.containsSections)
                  task = subcategory.sections[taskMap[index].sectionId].tasks[taskMap[index].taskId]
                <span class="hljs-keyword">else</span>
                  task = subcategory.tasks[taskMap[index].taskId]
                task.assignedEquipment.equipment = pieceOfEquipment;
              }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Change equipment status</p></div></div><div class="code"><div class="wrapper">              pieceOfEquipment.assigned = <span class="hljs-literal">true</span>;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Construct command and send</p></div></div><div class="code"><div class="wrapper">              <span class="hljs-keyword">var</span> command = <span class="hljs-keyword">this</span>.constructTaskCommand(<span class="hljs-string">'AssignEquipmentToPartialTask'</span>, clientSequence, boardLocation,
                  boardDate, task.id);
              command.commandContent.equipmentId = pieceOfEquipment.id;
              command.commandContent.locationId = locationId;

              <span class="hljs-keyword">return</span> command;
            },

            createAssignEquipmentToTaskCommand : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(states, clientSequence, boardLocation, boardDate, task,
                pieceOfEquipment, uniqueId)</span> </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Change equipment status</p></div></div><div class="code"><div class="wrapper">              pieceOfEquipment.assigned = <span class="hljs-literal">true</span>;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Assign equipment to task</p></div></div><div class="code"><div class="wrapper">              task.assignedEquipment.equipment = pieceOfEquipment;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Construct command and send</p></div></div><div class="code"><div class="wrapper">              <span class="hljs-keyword">var</span> command = <span class="hljs-keyword">this</span>.constructTaskCommand(<span class="hljs-string">'AssignEquipmentToTask'</span>, clientSequence, boardLocation,
                  boardDate, task.id);
              command.commandContent.equipmentId = pieceOfEquipment.id;
              command.commandContent.uniqueId = uniqueId;

              <span class="hljs-keyword">return</span> command;
            },

            createAssignPersonToPartialTaskCommand : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(states, clientSequence, boardLocation, boardDate, tasks,
                taskMap, task, person, position, locationId)</span> </span>{

              <span class="hljs-keyword">var</span> subcategoryTaskId, index = -<span class="hljs-number">1</span>;
              <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; taskMap.length; i++) {
                <span class="hljs-keyword">if</span> (taskMap[i].taskId === task.id) {
                  subcategoryTaskId = taskMap[i].subcategoryTaskId;
                  index = i;
                }
              }

              <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; taskMap.length; i++) {
                <span class="hljs-keyword">if</span> (taskMap[i].groupId === task.groupId) { <span class="hljs-comment">// will change this</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>late to push it
to array</p></div></div><div class="code"><div class="wrapper">                  <span class="hljs-keyword">var</span> category = tasks.locations[taskMap[i].locationId].locationShifts[taskMap[i].locationShiftId].shiftCategories[taskMap[i].shiftCategoryId], subcategory = category.subcategoryTasks[taskMap[i].subcategoryTaskId], task;
                  <span class="hljs-keyword">if</span> (subcategory.subcategory.containsSections)
                    task = subcategory.sections[taskMap[i].sectionId].tasks[taskMap[i].taskId]
                  <span class="hljs-keyword">else</span>
                    task = subcategory.tasks[taskMap[i].taskId]
                  <span class="hljs-keyword">if</span> (position == <span class="hljs-number">1</span>)
                    task.assignedPerson1.person = person;
                  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (position == <span class="hljs-number">2</span>)
                    task.assignedPerson2.person = person;
                }
              }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Change person status</p></div></div><div class="code"><div class="wrapper">              person.assigned = <span class="hljs-literal">true</span>;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Construct command and send</p></div></div><div class="code"><div class="wrapper">              <span class="hljs-keyword">var</span> command = <span class="hljs-keyword">this</span>.constructTaskCommand(<span class="hljs-string">'AssignPersonToPartialTask'</span>, clientSequence, boardLocation,
                  boardDate, task.id);
              command.commandContent.personId = person.id;
              command.commandContent.locationId = locationId;
              command.commandContent.position = position;

              <span class="hljs-keyword">return</span> command;

            },

            createAssignPersonToTaskCommand : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(states, clientSequence, boardLocation, boardDate, task, person,
                position, uniqueId, taskIndicator)</span> </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Change person status</p></div></div><div class="code"><div class="wrapper">              person.assigned = <span class="hljs-literal">true</span>;
              person.taskIndicator = taskIndicator;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Assign person to task</p></div></div><div class="code"><div class="wrapper">              task[<span class="hljs-string">"assignedPerson"</span> + position].person = person;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Construct command and send</p></div></div><div class="code"><div class="wrapper">              <span class="hljs-keyword">var</span> command = <span class="hljs-keyword">this</span>.constructTaskCommand(<span class="hljs-string">'AssignPersonToTask'</span>, clientSequence, boardLocation, boardDate,
                  task.id);
              command.commandContent.personId = person.id;
              command.commandContent.position = position;
              command.commandContent.assignType = task[<span class="hljs-string">"assignedPerson"</span> + position].type;
              command.commandContent.uniqueId = uniqueId;

              <span class="hljs-keyword">return</span> command;
            },

            createAssignSupervisorToSectionCommand : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(states, clientSequence, boardLocation, boardDate,
                section, person, taskIndicator)</span> </span>{

              person.assigned = <span class="hljs-literal">true</span>;
              <span class="hljs-keyword">var</span> tasks = section.tasks;
              <span class="hljs-built_in">Object</span>.keys(tasks).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(taskId)</span> </span>{
                <span class="hljs-keyword">var</span> task = tasks[taskId];
                <span class="hljs-keyword">if</span> (!task[<span class="hljs-string">"supervisorAssignments"</span>])
                  task[<span class="hljs-string">"supervisorAssignments"</span>] = [];

                <span class="hljs-keyword">var</span> sequenceNumber = task[<span class="hljs-string">"supervisorAssignments"</span>].length + <span class="hljs-number">1</span>;

                task[<span class="hljs-string">"supervisorAssignments"</span>].push({
                  sequenceNumber : sequenceNumber,
                  taskIndicator : taskIndicator,
                  person : person
                });

              })

              <span class="hljs-keyword">if</span> (!section.sectionSupervisorAssignments)
                section.sectionSupervisorAssignments = [];
              section.sectionSupervisorAssignments.push({
                personId : person.id,
                taskIndicator : taskIndicator
              });

              <span class="hljs-keyword">var</span> command = <span class="hljs-keyword">this</span>.constructTaskCommand(<span class="hljs-string">'AssignSupervisor'</span>, clientSequence, boardLocation, boardDate,
                  section.id);

              command.commandContent.personId = person.id;
              command.commandContent.sectionId = section.id;
              command.commandContent.taskId = <span class="hljs-literal">null</span>;
              command.commandContent.sequenceNumber = <span class="hljs-literal">null</span>;
              command.commandContent.taskIndicator = taskIndicator;

              <span class="hljs-keyword">return</span> command;
            },

            createAssignSupervisorToTaskCommand : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(states, clientSequence, boardLocation, boardDate, task,
                person, taskIndicator)</span> </span>{

              person.assigned = <span class="hljs-literal">true</span>;
              <span class="hljs-keyword">if</span> (!task[<span class="hljs-string">"supervisorAssignments"</span>])
                task[<span class="hljs-string">"supervisorAssignments"</span>] = [];

              <span class="hljs-keyword">var</span> sequenceNumber = task[<span class="hljs-string">"supervisorAssignments"</span>].length + <span class="hljs-number">1</span>;

              task[<span class="hljs-string">"supervisorAssignments"</span>].push({
                sequenceNumber : sequenceNumber,
                taskIndicator : taskIndicator,
                person : person
              });
              <span class="hljs-keyword">var</span> command = <span class="hljs-keyword">this</span>.constructTaskCommand(<span class="hljs-string">'AssignSupervisor'</span>, clientSequence, boardLocation, boardDate,
                  <span class="hljs-literal">null</span>);

              command.commandContent.personId = person.id;
              command.commandContent.sectionId = <span class="hljs-literal">null</span>;
              command.commandContent.taskId = task.id;
              command.commandContent.sequenceNumber = task[<span class="hljs-string">"supervisorAssignments"</span>].length;
              command.commandContent.taskIndicator = taskIndicator;

              <span class="hljs-keyword">return</span> command;
            },

            createUnassignEquipmentFromTaskCommand : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(states, clientSequence, boardLocation, boardDate,
                equipment, tasks, taskMap, task, locationId)</span> </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Unassign equipment from task</p></div></div><div class="code"><div class="wrapper">              <span class="hljs-keyword">var</span> equipmentId = task.assignedEquipment.equipment.id;

              <span class="hljs-keyword">if</span> (task.groupId) {
                <span class="hljs-keyword">var</span> subcategoryTaskId, index = -<span class="hljs-number">1</span>;
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; taskMap.length; i++) {
                  <span class="hljs-keyword">if</span> (taskMap[i].taskId === task.id) {
                    subcategoryTaskId = taskMap[i].subcategoryTaskId;
                    index = i;
                  }
                }
                <span class="hljs-keyword">var</span> homogeneous = <span class="hljs-literal">true</span>;
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; taskMap.length; i++) {
                  <span class="hljs-keyword">if</span> (taskMap[i].groupId === task.groupId)
                    <span class="hljs-keyword">if</span> (taskMap[i].subcategoryTaskId !== subcategoryTaskId)
                      homogeneous = <span class="hljs-literal">false</span>;
                }

                <span class="hljs-keyword">if</span> (homogeneous) {
                  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; taskMap.length; i++) {
                    <span class="hljs-keyword">if</span> (taskMap[i].groupId === task.groupId) { <span class="hljs-comment">// will change</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>this late to
push it to
array</p></div></div><div class="code"><div class="wrapper">                      <span class="hljs-keyword">var</span> category = tasks.locations[taskMap[i].locationId].locationShifts[taskMap[i].locationShiftId].shiftCategories[taskMap[i].shiftCategoryId], subcategory = category.subcategoryTasks[taskMap[i].subcategoryTaskId], taskU;
                      <span class="hljs-keyword">if</span> (subcategory.subcategory.containsSections)
                        taskU = subcategory.sections[taskMap[i].sectionId].tasks[taskMap[i].taskId]
                      <span class="hljs-keyword">else</span>
                        taskU = subcategory.tasks[taskMap[i].taskId]
                      taskU.assignedEquipment.equipment = <span class="hljs-literal">null</span>;
                    }
                  }
                } <span class="hljs-keyword">else</span> {
                  task.assignedEquipment.equipment = <span class="hljs-literal">null</span>;
                }
              } <span class="hljs-keyword">else</span> {
                task.assignedEquipment.equipment = <span class="hljs-literal">null</span>;
              }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Change equipment status</p></div></div><div class="code"><div class="wrapper">              equipment[equipmentId].state = states.equipment.available;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Construct command and send</p></div></div><div class="code"><div class="wrapper">              <span class="hljs-keyword">var</span> command;
              <span class="hljs-keyword">if</span> (!task.groupId) {
                command = <span class="hljs-keyword">this</span>.constructTaskCommand(<span class="hljs-string">'UnassignEquipmentFromTask'</span>, clientSequence, boardLocation,
                    boardDate, task.id);
              } <span class="hljs-keyword">else</span> {
                command = <span class="hljs-keyword">this</span>.constructTaskCommand(<span class="hljs-string">'UnassignEquipmentFromPartialTask'</span>, clientSequence, boardLocation,
                    boardDate, task.id);
                command.commandContent.locationId = locationId;
              }
              command.commandContent.equipmentId = equipmentId;

              <span class="hljs-keyword">return</span> command;
            },

            createUnassignPersonFromTaskCommand : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(states, clientSequence, boardLocation, boardDate, personnel,
                tasks, position, taskMap, task, locationId, person)</span> </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Unassign person from task</p></div></div><div class="code"><div class="wrapper">              <span class="hljs-keyword">var</span> personId;
              <span class="hljs-keyword">if</span> (position == <span class="hljs-number">1</span>)
                personId = task.assignedPerson1.person.id;
              <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (position == <span class="hljs-number">2</span>)
                personId = task.assignedPerson2.person.id;

              <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; taskMap.length; i++) {
                <span class="hljs-keyword">if</span> (taskMap[i].groupId === task.groupId) {
                  <span class="hljs-keyword">var</span> category = tasks.locations[taskMap[i].locationId].locationShifts[taskMap[i].locationShiftId].shiftCategories[taskMap[i].shiftCategoryId], subcategory = category.subcategoryTasks[taskMap[i].subcategoryTaskId], taskU;
                  <span class="hljs-keyword">if</span> (subcategory.subcategory.containsSections)
                    taskU = subcategory.sections[taskMap[i].sectionId].tasks[taskMap[i].taskId]
                  <span class="hljs-keyword">else</span>
                    taskU = subcategory.tasks[taskMap[i].taskId]
                  <span class="hljs-keyword">if</span> (position == <span class="hljs-number">1</span>)
                    taskU.assignedPerson1.person = <span class="hljs-literal">null</span>;
                  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (position == <span class="hljs-number">2</span>)
                    taskU.assignedPerson2.person = <span class="hljs-literal">null</span>;
                }
              }

              <span class="hljs-keyword">if</span> (position == <span class="hljs-number">1</span>)
                task.assignedPerson1.person = <span class="hljs-literal">null</span>;
              <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (position == <span class="hljs-number">2</span>)
                task.assignedPerson2.person = <span class="hljs-literal">null</span>;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Construct command and send</p></div></div><div class="code"><div class="wrapper">              <span class="hljs-keyword">var</span> command;
              <span class="hljs-keyword">if</span> (!task.groupId) {
                command = <span class="hljs-keyword">this</span>.constructTaskCommand(<span class="hljs-string">'UnassignPersonFromTask'</span>, clientSequence, boardLocation, boardDate,
                    task.id);
              } <span class="hljs-keyword">else</span> {
                command = <span class="hljs-keyword">this</span>.constructTaskCommand(<span class="hljs-string">'UnassignPersonFromPartialTask'</span>, clientSequence, boardLocation,
                    boardDate, task.id);
                command.commandContent.locationId = locationId;
              }
              command.commandContent.personId = personId;
              command.commandContent.position = position;

              <span class="hljs-keyword">return</span> command;
            },

            createUnassignSupervisorCommand : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(states, clientSequence, boardLocation, boardDate, tasks,
                section, task)</span> </span>{
              <span class="hljs-keyword">var</span> taskId, command, taskRemoval = [], sectionRemoval = [];
              <span class="hljs-keyword">if</span> (!task) {
                <span class="hljs-keyword">var</span> section = findSection(section.id, tasks);
                command = <span class="hljs-keyword">this</span>.constructTaskCommand(<span class="hljs-string">'UnassignSupervisor'</span>, clientSequence, boardLocation, boardDate,
                    <span class="hljs-literal">null</span>);
                command.commandContent.sectionId = section.id;
                command.commandContent.sectionSupervisorAssignments = angular
                    .copy(section.sectionSupervisorAssignments);
                <span class="hljs-built_in">Object</span>
                    .keys(section.tasks)
                    .forEach(
                        <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(taskId)</span> </span>{
                          <span class="hljs-keyword">var</span> task = section.tasks[taskId]
                          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j = <span class="hljs-number">0</span>; j &lt; section.sectionSupervisorAssignments.length; j++) {
                            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; task.supervisorAssignments.length; i++) {
                              <span class="hljs-keyword">if</span> (task.supervisorAssignments[i].taskIndicator === section.sectionSupervisorAssignments[j].taskIndicator
                                  &amp;&amp; task.supervisorAssignments[i].person.id === section.sectionSupervisorAssignments[j].personId) {
                                taskRemoval.push(i);
                                sectionRemoval.push(j);
                              }
                            }
                          }
                          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> k = <span class="hljs-number">0</span>; k &lt; taskRemoval.length; k++) {
                            task.supervisorAssignments.splice(taskRemoval[k], <span class="hljs-number">1</span>)
                          }
                          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> l = <span class="hljs-number">0</span>; l &lt; sectionRemoval.length; l++) {
                            section.sectionSupervisorAssignments.splice(taskRemoval[l], <span class="hljs-number">1</span>)
                          }
                        })
              } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">var</span> task = findTask(task.id, tasks);
                command = <span class="hljs-keyword">this</span>.constructTaskCommand(<span class="hljs-string">'UnassignSupervisor'</span>, clientSequence, boardLocation, boardDate,
                    task.id);
                <span class="hljs-keyword">if</span> (section &amp;&amp; section != <span class="hljs-string">'null'</span>) {
                  <span class="hljs-keyword">var</span> section = findSection(section.id, tasks);
                  command.commandContent.sectionSupervisorAssignments = section.sectionSupervisorAssignments;
                  <span class="hljs-built_in">Object</span>
                      .keys(section.tasks)
                      .forEach(
                          <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(taskId)</span> </span>{
                            <span class="hljs-keyword">var</span> task = section.tasks[taskId], taskRemoval = [];
                            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j = <span class="hljs-number">0</span>; j &lt; task.supervisorAssignments.length; j++) {
                              <span class="hljs-keyword">var</span> found = <span class="hljs-literal">false</span>;
                              <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; section.sectionSupervisorAssignments
                                  &amp;&amp; i &lt; section.sectionSupervisorAssignments.length; i++) {
                                <span class="hljs-keyword">if</span> (task.supervisorAssignments[j].taskIndicator === section.sectionSupervisorAssignments[i].taskIndicator
                                    &amp;&amp; task.supervisorAssignments[j].person.id === section.sectionSupervisorAssignments[i].personId) {
                                  found = <span class="hljs-literal">true</span>;
                                }
                              }
                              <span class="hljs-keyword">if</span> (!found) {
                                taskRemoval.push(j);
                              }
                            }
                            <span class="hljs-keyword">if</span> (taskRemoval.length !== <span class="hljs-number">0</span>) {
                              <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> k = <span class="hljs-number">0</span>; k &lt; taskRemoval.length; k++) {
                                task.supervisorAssignments.splice(taskRemoval[k], <span class="hljs-number">1</span>);
                              }
                            }
                          })
                } <span class="hljs-keyword">else</span> {
                  task.supervisorAssignments.length = <span class="hljs-number">0</span>;
                }
              }

              <span class="hljs-keyword">return</span> command;
            },

            createUnlinkPartialTasksCommand : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(states, clientSequence, boardLocation, boardDate, equipment,
                personnel, tasks, taskMap, route)</span> </span>{
              <span class="hljs-keyword">var</span> groupId = route[<span class="hljs-number">0</span>].groupId, subcategoryTaskId = route[<span class="hljs-number">0</span>].subcategoryTaskId, locationId = route[<span class="hljs-number">0</span>].locationId, taskId = route[<span class="hljs-number">0</span>].taskId, homogeneous = <span class="hljs-literal">true</span>;
              <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; route.length; i++) {
                <span class="hljs-keyword">if</span> (route[i].subcategoryTaskId !== subcategoryTaskId)
                  homogeneous = <span class="hljs-literal">false</span>;
              }

              <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; route.length; i++) {

                <span class="hljs-keyword">var</span> category = tasks.locations[route[i].locationId].locationShifts[route[i].locationShiftId].shiftCategories[route[i].shiftCategoryId], subcategory = category.subcategoryTasks[route[i].subcategoryTaskId], task;
                <span class="hljs-keyword">if</span> (subcategory.subcategory.containsSections)
                  task = subcategory.sections[route[i].sectionId].tasks[route[i].taskId]
                <span class="hljs-keyword">else</span>
                  task = subcategory.tasks[route[i].taskId]

                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j = <span class="hljs-number">0</span>; j &lt; taskMap; j++)
                  <span class="hljs-keyword">if</span> (taskMap[j].taskId === route[i].taskId)
                    <span class="hljs-keyword">delete</span> taskMap[j]

                <span class="hljs-keyword">delete</span> task.linkedTaskChildId
                <span class="hljs-keyword">delete</span> task.linkedTaskParentId
                <span class="hljs-keyword">delete</span> task.partialTaskSequence
                <span class="hljs-keyword">delete</span> task.groupId
                <span class="hljs-keyword">delete</span> task.homogeneous

                <span class="hljs-keyword">if</span> (route[i].sequence != <span class="hljs-number">1</span>) {
                  task.assignedPerson1.person = <span class="hljs-literal">null</span>;
                  task.assignedPerson2.person = <span class="hljs-literal">null</span>;

                  <span class="hljs-keyword">if</span> (homogeneous)
                    task.assignedEquipment.equipment = <span class="hljs-literal">null</span>;
                }
              }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Construct command and send</p></div></div><div class="code"><div class="wrapper">              <span class="hljs-keyword">var</span> command = <span class="hljs-keyword">this</span>.constructTaskCommand(<span class="hljs-string">'UnlinkPartialTask'</span>, clientSequence, boardLocation, boardDate,
                  taskId);
              command.commandContent.locationId = locationId;
              <span class="hljs-keyword">return</span> command;
            },</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Section - Perform operations on server - End </p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Section - Create Commands for Server - End </p></div></div><div class="code"><div class="wrapper">            processEquipmentFromPartialTaskCommand : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(states, tasks, equipment, command)</span> </span>{
              <span class="hljs-keyword">var</span> e = equipment[command.commandContent.equipmentId];
              e.assigned = <span class="hljs-literal">false</span>;
              e.state = command.commandContent.state;

              <span class="hljs-keyword">var</span> task;
              <span class="hljs-keyword">var</span> assignments = command.commandContent.assignments;
              <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; assignments.length; i++) {
                task = findTask(assignments[i].taskId, tasks);
                task.assignedEquipment.equipment = <span class="hljs-literal">null</span>;
                task.assignedEquipment.assignmentTime = <span class="hljs-literal">null</span>;
              }
            },

            processEquipmentFromTaskCommand : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(states, tasks, equipment, command)</span> </span>{
              <span class="hljs-keyword">var</span> e = equipment[command.commandContent.equipmentId];
              e.assigned = <span class="hljs-literal">false</span>;
              e.state = command.commandContent.state;

              <span class="hljs-keyword">var</span> task = findTask(command.commandContent.taskId, tasks);
              task.assignedEquipment.equipment = <span class="hljs-literal">null</span>;
              task.assignedEquipment.assignmentTime = <span class="hljs-literal">null</span>;
            },

            processEquipmentToPartialTaskCommand : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(user, states, tasks, equipment, command, root_scope)</span> </span>{
              <span class="hljs-keyword">var</span> equipmentId = command.commandContent.equipmentId;
              <span class="hljs-keyword">var</span> assignments = command.commandContent.assignments;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Update equipment assignment flag and state</p></div></div><div class="code"><div class="wrapper">              equipment[equipmentId].assigned = command.commandContent.assigned;
              equipment[equipmentId].state = command.commandContent.state;

              <span class="hljs-keyword">var</span> task;
              <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; assignments.length; i++) {
                task = findTask(assignments[i].taskId, tasks);
                task.assignedEquipment.assignmentTime = assignments[i].assignmentTime;
                task.assignedEquipment.equipment = equipment[equipmentId]; <span class="hljs-comment">// override</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>from
server</p></div></div><div class="code"><div class="wrapper">              }

              <span class="hljs-keyword">if</span> (user.username !== command.user)
                root_scope.pushedId = equipmentId;
            },

            processEquipmentToTaskCommand : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(user, states, tasks, equipment, command, root_scope)</span> </span>{
              <span class="hljs-keyword">var</span> equipmentId = command.commandContent.equipmentId;
              <span class="hljs-keyword">var</span> task = findTask(command.commandContent.taskId, tasks);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Update equipment assignment flag and state</p></div></div><div class="code"><div class="wrapper">              equipment[equipmentId].assigned = command.commandContent.assigned;
              equipment[equipmentId].state = command.commandContent.state;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Set task assignment details</p></div></div><div class="code"><div class="wrapper">              task.assignedEquipment.assignmentTime = command.commandContent.assignmentTime;
              task.assignedEquipment.equipment = equipment[equipmentId]; <span class="hljs-comment">// override</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>from
server</p></div></div><div class="code"><div class="wrapper">              <span class="hljs-keyword">if</span> (user.username !== command.user)
                root_scope.pushedId = equipmentId;
            },

            processErrorCommand : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(user, equipment, personnel, tasks, states, command, rootScope,
                browserUniqueId)</span> </span>{
              <span class="hljs-keyword">if</span> (command.commandContent.command.uniqueId == browserUniqueId) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>alert(command.commandContent.command.uniqueId);
alert(browserUniqueId);</p></div></div><div class="code"><div class="wrapper">                <span class="hljs-keyword">switch</span> (command.commandContent.command.name) {
                  <span class="hljs-keyword">case</span> <span class="hljs-string">'AssignEquipmentToTask'</span>:
                    processErrorInEquipmentToTaskCommand(user, equipment, personnel, tasks, states, command, rootScope,
                        browserUniqueId);
                    <span class="hljs-keyword">break</span>;
                  <span class="hljs-keyword">case</span> <span class="hljs-string">'AssignPersonToTask'</span>:
                    processErrorInPersonToTaskCommand(user, equipment, personnel, tasks, states, command, rootScope,
                        browserUniqueId);
                    <span class="hljs-keyword">break</span>;
                }
              }
            },

            processPersonFromPartialTaskCommand : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(states, tasks, personnel, command)</span> </span>{
              <span class="hljs-keyword">var</span> personId = command.commandContent.personId;
              <span class="hljs-keyword">var</span> taskIds = command.commandContent.taskIds;
              <span class="hljs-keyword">var</span> position = command.commandContent.position;
              <span class="hljs-keyword">var</span> task;
              <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; taskIds.length; i++) {
                task = findTask(taskIds[i], tasks);
                <span class="hljs-keyword">if</span> (position == <span class="hljs-number">1</span>)
                  task.assignedPerson1.person = <span class="hljs-literal">null</span>;
                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (position == <span class="hljs-number">2</span>)
                  task.assignedPerson2.person = <span class="hljs-literal">null</span>;

                <span class="hljs-keyword">if</span> (!command.commandContent.personAssignedtoOtherTask) {
                  personnel[personId].assigned = <span class="hljs-literal">false</span>;
                } <span class="hljs-keyword">else</span> {
                  personnel[personId].assigned = <span class="hljs-literal">true</span>;
                }
              }
            },

            processPersonFromTaskCommand : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(states, tasks, personnel, command)</span> </span>{
              <span class="hljs-keyword">var</span> personId = command.commandContent.personId, position = command.commandContent.position;
              <span class="hljs-keyword">var</span> task = findTask(command.commandContent.taskId, tasks);
              task[<span class="hljs-string">'assignedPerson'</span> + position].person = <span class="hljs-literal">null</span>;
              <span class="hljs-keyword">if</span> (!command.commandContent.personAssignedtoOtherTask) {
                personnel[personId].assigned = <span class="hljs-literal">false</span>;
              } <span class="hljs-keyword">else</span> {
                personnel[personId].assigned = <span class="hljs-literal">true</span>;
              }

            },

            processPersonToPartialTaskCommand : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(user, states, tasks, personnel, command, root_scope)</span> </span>{

              <span class="hljs-keyword">var</span> personId = command.commandContent.personId;
              <span class="hljs-keyword">var</span> taskIds = command.commandContent.taskIds;
              <span class="hljs-keyword">var</span> position = command.commandContent.position;
              <span class="hljs-keyword">var</span> task;
              <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; taskIds.length; i++) {
                task = findTask(taskIds[i], tasks);
                personnel[personId].assigned = <span class="hljs-literal">true</span>;
                <span class="hljs-keyword">if</span> (position == <span class="hljs-number">1</span>)
                  task.assignedPerson1.person = personnel[personId];
                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (position == <span class="hljs-number">2</span>)
                  task.assignedPerson2.person = personnel[personId];
              }
              <span class="hljs-keyword">if</span> (user.username !== command.user)
                root_scope.pushedId = personId;
            },

            processPersonToTaskCommand : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(user, states, tasks, personnel, command, root_scope)</span> </span>{

              <span class="hljs-keyword">var</span> personId = command.commandContent.personId, position = command.commandContent.position;
              <span class="hljs-keyword">var</span> task = findTask(command.commandContent.taskId, tasks);

              personnel[personId].assigned = <span class="hljs-literal">true</span>;
              task[<span class="hljs-string">'assignedPerson'</span> + position].person = personnel[personId];

              <span class="hljs-keyword">if</span> (user.username !== command.user)
                root_scope.pushedId = personId;
            },

            processSetPartialTaskCommand : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(tasks, command, groupCnt, linkedTaskMap)</span> </span>{
              <span class="hljs-keyword">var</span> locationId = command.commandContent.locationId, locationShiftId = command.commandContent.locationShiftId;

              <span class="hljs-keyword">var</span> groupId = groupCnt.cnt++ % <span class="hljs-number">18</span>;
              <span class="hljs-keyword">var</span> shift = tasks.locations[locationId].locationShifts[locationShiftId];
              <span class="hljs-keyword">var</span> subcategoryTaskId = command.commandContent.partialTasks[<span class="hljs-number">0</span>].subCategoryId;
              <span class="hljs-keyword">var</span> homogeneous = <span class="hljs-literal">true</span>;
              <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; command.commandContent.partialTasks.length; i++)
                <span class="hljs-keyword">if</span> (command.commandContent.partialTasks[i].subCategoryId !== subcategoryTaskId)
                  homogeneous = <span class="hljs-literal">false</span>;

              <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; command.commandContent.partialTasks.length; i++) {
                <span class="hljs-keyword">var</span> task = command.commandContent.partialTasks[i], taskId = task.id, sequence = task.task.partialTaskSequence, subcategoryId = task.subCategoryId, categoryId = task.categoryId, duration = task.hours, category = tasks.locations[locationId].locationShifts[locationShiftId].shiftCategories[categoryId], subcategory = category.subcategoryTasks[subcategoryId], peoplePerTask = subcategory.peoplePerTask;

                <span class="hljs-keyword">var</span> label = category.category.name + <span class="hljs-string">" - "</span> + subcategory.subcategory.name + <span class="hljs-string">"/ "</span>;
                <span class="hljs-keyword">if</span> (subcategory.subcategory.containsSections)
                  label = label + subcategory.sections[task.sectionId].section.name + <span class="hljs-string">" / "</span>;
                label = label + task.taskName;

                <span class="hljs-keyword">var</span> found = <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j = <span class="hljs-number">0</span>; j &lt; linkedTaskMap; j++)
                  <span class="hljs-keyword">if</span> (linkedTaskMap[j].taskId === task.id)
                    found = <span class="hljs-literal">true</span>;
                <span class="hljs-keyword">if</span> (!found) {
                  linkedTaskMap.push({
                    locationId : locationId,
                    locationShiftId : locationShiftId,
                    shiftCategoryId : categoryId,
                    subcategoryTaskId : subcategoryId,
                    sectionId : task.sectionId,
                    containsSections : task.containsSections,
                    peoplePerTask : peoplePerTask,
                    taskId : taskId,
                    sequence : sequence,
                    label : label,
                    duration : duration,
                    groupId : groupId,
                    linkedTaskChildId : task.linkedTaskChildId,
                    linkedTaskParentId : task.linkedTaskParentId,
                  })
                }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>removed by sri with Sandesh&#39;s permission
var grpId = task.groupId.replace(/\D/g, &#39;&#39;);</p></div></div><div class="code"><div class="wrapper">                task.task.groupId = groupId;
                task.task.homogeneous = homogeneous;
                <span class="hljs-keyword">if</span> (subcategory.subcategory.containsSections)
                  subcategory.sections[task.sectionId].tasks[taskId] = task.task;
                <span class="hljs-keyword">else</span>
                  subcategory.tasks[taskId] = task.task;
              }

            },

            processSupervisorToTaskCommand : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(user, states, tasks, personnel, command, root_scope)</span> </span>{
              <span class="hljs-keyword">var</span> personId = command.commandContent.personId, sequenceNumber = command.commandContent.sequenceNumber, position = sequenceNumber - <span class="hljs-number">1</span>, taskIndicator = command.commandContent.taskIndicator;
              <span class="hljs-keyword">if</span> (command.commandContent.taskId) {
                <span class="hljs-keyword">var</span> task = findTask(command.commandContent.taskId, tasks);

                personnel[personId].assigned = <span class="hljs-literal">true</span>;
                <span class="hljs-keyword">if</span> (!task[<span class="hljs-string">"supervisorAssignments"</span>])
                  task[<span class="hljs-string">"supervisorAssignments"</span>] = [];

                task[<span class="hljs-string">"supervisorAssignments"</span>][position] = {
                  person : personnel[personId]
                };
                task[<span class="hljs-string">"supervisorAssignments"</span>][position].sequenceNumber = sequenceNumber;
                task[<span class="hljs-string">"supervisorAssignments"</span>][position].taskIndicator = taskIndicator;
              } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">var</span> exists = <span class="hljs-literal">true</span>, section = findSection(command.commandContent.sectionId, tasks), taskMap = command.commandContent.taskSequenceNumberMap;
                <span class="hljs-built_in">Object</span>.keys(taskMap).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(taskId)</span> </span>{
                  <span class="hljs-keyword">var</span> task = findTask(taskId, tasks), pos = taskMap[taskId] - <span class="hljs-number">1</span>;

                  <span class="hljs-keyword">if</span> (!task[<span class="hljs-string">"supervisorAssignments"</span>])
                    task[<span class="hljs-string">"supervisorAssignments"</span>] = [];
                  <span class="hljs-keyword">if</span> (!task[<span class="hljs-string">"supervisorAssignments"</span>][pos]) {
                    exists = <span class="hljs-literal">false</span>;
                    task[<span class="hljs-string">"supervisorAssignments"</span>][pos] = {
                      person : personnel[personId],
                      sequenceNumber : taskMap[taskId],
                      taskIndicator : taskIndicator
                    };
                  }
                })
                <span class="hljs-keyword">if</span> (!exists) {
                  <span class="hljs-keyword">if</span> (!section.sectionSupervisorAssignments || section.sectionSupervisorAssignments.length === <span class="hljs-number">0</span>)
                    section.sectionSupervisorAssignments = [];
                  section.sectionSupervisorAssignments.push({
                    personId : personId,
                    taskIndicator : taskIndicator
                  })
                }
              }
            },

            processUnassignSupervisorCommand : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(user, states, tasks, personnel, command, root_scope)</span> </span>{
              <span class="hljs-keyword">var</span> taskRemoval = [], sectionRemoval = [];
              <span class="hljs-keyword">if</span> (command.commandContent.taskId) {
                <span class="hljs-keyword">var</span> task = findTask(command.commandContent.taskId, tasks), sectionSupervisorAssignments = command.commandContent.sectionSupervisorAssignments;
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j = <span class="hljs-number">0</span>; j &lt; task.supervisorAssignments.length; j++) {
                  <span class="hljs-keyword">var</span> found = <span class="hljs-literal">false</span>;
                  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; sectionSupervisorAssignments.length; i++) {
                    <span class="hljs-keyword">if</span> (task.supervisorAssignments[j].taskIndicator === sectionSupervisorAssignments[i].taskIndicator
                        &amp;&amp; task.supervisorAssignments[j].person.id === sectionSupervisorAssignments[i].personId) {
                      found = <span class="hljs-literal">true</span>;
                    }
                  }
                  <span class="hljs-keyword">if</span> (!found) {
                    taskRemoval.push(j);
                  }
                }
                <span class="hljs-keyword">if</span> (taskRemoval.length !== <span class="hljs-number">0</span>) {
                  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> k = <span class="hljs-number">0</span>; k &lt; taskRemoval.length; k++) {
                    task.supervisorAssignments.splice(taskRemoval[k], <span class="hljs-number">1</span>);
                  }
                }
              } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">var</span> section = findSection(command.commandContent.sectionId, tasks);
                <span class="hljs-built_in">Object</span>
                    .keys(section.tasks)
                    .forEach(
                        <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(taskId)</span> </span>{
                          <span class="hljs-keyword">var</span> task = section.tasks[taskId]
                          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j = <span class="hljs-number">0</span>; j &lt; section.sectionSupervisorAssignments.length; j++) {
                            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; task.supervisorAssignments.length; i++) {
                              <span class="hljs-keyword">if</span> (task.supervisorAssignments[i].taskIndicator === section.sectionSupervisorAssignments[j].taskIndicator
                                  &amp;&amp; task.supervisorAssignments[i].person.id === section.sectionSupervisorAssignments[j].personId) {
                                taskRemoval.push(i);
                                sectionRemoval.push(j);
                              }
                            }
                          }
                          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> k = <span class="hljs-number">0</span>; k &lt; taskRemoval.length; k++) {
                            task.supervisorAssignments.splice(taskRemoval[k], <span class="hljs-number">1</span>)
                          }
                          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> l = <span class="hljs-number">0</span>; l &lt; sectionRemoval.length; l++) {
                            section.sectionSupervisorAssignments.splice(taskRemoval[l], <span class="hljs-number">1</span>)
                          }
                        })

              }

            },

            processUnlinkPartialTaskCommand : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(tasks, command, groupCnt, linkedTaskMap)</span> </span>{
              <span class="hljs-keyword">var</span> locationId = command.commandContent.locationId, locationShiftId = command.commandContent.shiftId, subcategoryTaskId = command.commandContent.partialTasks[<span class="hljs-number">0</span>].subCategoryId, homogeneous = <span class="hljs-literal">true</span>;

              <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; command.commandContent.partialTasks.length; i++)
                <span class="hljs-keyword">if</span> (command.commandContent.partialTasks[i].subCategoryId !== subcategoryTaskId)
                  homogeneous = <span class="hljs-literal">false</span>;

              <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; command.commandContent.partialTasks.length; i++) {
                <span class="hljs-keyword">var</span> task = command.commandContent.partialTasks[i], taskId = task.task.id, sequence = task.sequence, subcategoryId = task.subCategoryId, categoryId = task.categoryId, duration = task.hours, category = tasks.locations[locationId].locationShifts[locationShiftId].shiftCategories[categoryId], subcategory = category.subcategoryTasks[subcategoryId], peoplePerTask = subcategory.peoplePerTask;

                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j = <span class="hljs-number">0</span>; j &lt; linkedTaskMap; j++)
                  <span class="hljs-keyword">if</span> (linkedTaskMap[j].taskId === task.id)
                    <span class="hljs-keyword">delete</span> linkedTaskMap[j]

                <span class="hljs-keyword">var</span> actualTask;
                <span class="hljs-keyword">if</span> (subcategory.subcategory.containsSections)
                  actualTask = subcategory.sections[task.sectionId].tasks[taskId]
                <span class="hljs-keyword">else</span>
                  actualTask = subcategory.tasks[taskId];

                <span class="hljs-keyword">delete</span> actualTask.linkedTaskChildId
                <span class="hljs-keyword">delete</span> actualTask.linkedTaskParentId
                <span class="hljs-keyword">delete</span> actualTask.partialTaskSequence
                <span class="hljs-keyword">delete</span> actualTask.groupId
                <span class="hljs-keyword">delete</span> actualTask.homogeneous

                <span class="hljs-keyword">if</span> (task.sequence != <span class="hljs-number">1</span>) {
                  actualTask.assignedPerson1.person = <span class="hljs-literal">null</span>;
                  actualTask.assignedPerson2.person = <span class="hljs-literal">null</span>;

                  <span class="hljs-keyword">if</span> (homogeneous)
                    actualTask.assignedEquipment.equipment = <span class="hljs-literal">null</span>;
                }

              }
            },</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Section - Handle Server Commands - End </p></div></div><div class="code"><div class="wrapper">            sortByKey : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(array, key)</span> </span>{
              <span class="hljs-keyword">return</span> array.sort(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a, b)</span> </span>{
                <span class="hljs-keyword">var</span> x = a[key];
                <span class="hljs-keyword">var</span> y = b[key];

                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> x == <span class="hljs-string">"string"</span>) {
                  x = x.toLowerCase();
                  y = y.toLowerCase();
                }

                <span class="hljs-keyword">return</span> ((x &lt; y) ? -<span class="hljs-number">1</span> : ((x &gt; y) ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>));
              });
            },

            marshallTasks : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data, categories, taskMap, groupCnt)</span> </span>{
              taskMap.length = <span class="hljs-number">0</span>;
              groupCnt.cnt = <span class="hljs-number">1</span>;
              <span class="hljs-built_in">Object</span>
                  .keys(data.locations)
                  .forEach(
                      <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key)</span> </span>{
                        data.locations[key].location.sections = [ <span class="hljs-string">'1'</span>, <span class="hljs-string">'2'</span>, <span class="hljs-string">'3'</span>, <span class="hljs-string">'4'</span> ];
                        <span class="hljs-keyword">if</span> (data.locations[key].locationShifts) {
                          <span class="hljs-built_in">Object</span>
                              .keys(data.locations[key].locationShifts)
                              .forEach(
                                  <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(shiftId)</span> </span>{
                                    <span class="hljs-keyword">var</span> shift = data.locations[key].locationShifts[shiftId].shift;
                                    shift.type = InfoService.getShiftType(shift); <span class="hljs-comment">//need to be removed once Java starts sending type)</span>
                                    <span class="hljs-keyword">if</span> (data.locations[key].locationShifts[shiftId].shiftCategories) {
                                      <span class="hljs-built_in">Object</span>
                                          .keys(data.locations[key].locationShifts[shiftId].shiftCategories)
                                          .forEach(
                                              <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(categoryId)</span> </span>{
                                                <span class="hljs-keyword">if</span> (categories != <span class="hljs-literal">null</span>)
                                                  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; categories.length; i++) {
                                                    <span class="hljs-keyword">if</span> (data.locations[key].locationShifts[shiftId].shiftCategories[categoryId].category.id == categories[i].id) {
                                                      data.locations[key].locationShifts[shiftId].shiftCategories[categoryId].allsubcategoryTasks = angular
                                                          .copy(categories[i].subcategories);
                                                      <span class="hljs-keyword">if</span> (data.locations[key].locationShifts[shiftId].shiftCategories[categoryId].subcategoryTasks) {
                                                        <span class="hljs-keyword">var</span> subs = data.locations[key].locationShifts[shiftId].shiftCategories[categoryId].subcategoryTasks, allSubs = data.locations[key].locationShifts[shiftId].shiftCategories[categoryId].allsubcategoryTasks;
                                                        <span class="hljs-built_in">Object</span>
                                                            .keys(subs)
                                                            .forEach(
                                                                <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(subId)</span> </span>{
                                                                  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> k = <span class="hljs-number">0</span>; k &lt; allSubs.length; k++) {
                                                                    <span class="hljs-keyword">if</span> (subs[subId].subcategory.id == allSubs[k].id) {
                                                                      allSubs[k].selected = <span class="hljs-literal">true</span>;
                                                                    }
                                                                  }
                                                                  <span class="hljs-keyword">if</span> (subs[subId].subcategory.containsSections) {
                                                                    subs[subId].allSections = [];
                                                                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> l = <span class="hljs-number">0</span>; l &lt; data.locations[key].location.sections.length; l++) {
                                                                      <span class="hljs-keyword">var</span> selected = <span class="hljs-literal">false</span>, cnt = <span class="hljs-number">0</span>, id = <span class="hljs-number">0</span>, name = <span class="hljs-number">0</span>;
                                                                      <span class="hljs-built_in">Object</span>
                                                                          .keys(subs[subId].sections)
                                                                          .forEach(
                                                                              <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(sectionId)</span> </span>{
                                                                                <span class="hljs-keyword">if</span> (l === <span class="hljs-number">0</span>) {
                                                                                  <span class="hljs-built_in">Object</span>
                                                                                      .keys(
                                                                                          subs[subId].sections[sectionId].tasks)
                                                                                      .forEach(
                                                                                          <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(taskId)</span> </span>{
                                                                                            <span class="hljs-keyword">var</span> task = subs[subId].sections[sectionId].tasks[taskId];
                                                                                            <span class="hljs-keyword">if</span> (task.linkedTaskChildId
                                                                                                || task.linkedTaskParentId) {
                                                                                              taskMap
                                                                                                  .push({
                                                                                                    locationId : key,
                                                                                                    locationShiftId : shiftId,
                                                                                                    shiftCategoryId : categoryId,
                                                                                                    subcategoryTaskId : subId,
                                                                                                    sectionId : sectionId,
                                                                                                    containsSections : <span class="hljs-literal">true</span>,
                                                                                                    peoplePerTask : subs[subId].subcategory.peoplePerTask,
                                                                                                    taskId : taskId,
                                                                                                    sequence : task.sequence,
                                                                                                    linkedTaskChildId : task.linkedTaskChildId,
                                                                                                    linkedTaskParentId : task.linkedTaskParentId,
                                                                                                  })
                                                                                            }
                                                                                          })
                                                                                }
                                                                                <span class="hljs-keyword">if</span> (subs[subId].sections[sectionId].section
                                                                                    &amp;&amp; subs[subId].sections[sectionId].section.id == l + <span class="hljs-number">1</span>) {
                                                                                  selected = <span class="hljs-literal">true</span>;
                                                                                  cnt = <span class="hljs-built_in">Object</span>
                                                                                      .keys(subs[subId].sections[sectionId].tasks).length;
                                                                                  id = subs[subId].sections[sectionId].section.id;
                                                                                  name = subs[subId].sections[sectionId].section.name;
                                                                                }
                                                                              })
                                                                      subs[subId].allSections.push({
                                                                        id : id ? id
                                                                            : data.locations[key].location.sections[l],
                                                                        name : name ? name
                                                                            : data.locations[key].location.sections[l],
                                                                        selected : selected,
                                                                        numOfTasks : cnt,
                                                                        tasks : []
                                                                      })
                                                                    }
                                                                  } <span class="hljs-keyword">else</span> {
                                                                    <span class="hljs-built_in">Object</span>
                                                                        .keys(subs[subId].tasks)
                                                                        .forEach(
                                                                            <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(taskId)</span> </span>{
                                                                              <span class="hljs-keyword">var</span> task = subs[subId].tasks[taskId];
                                                                              <span class="hljs-keyword">if</span> (task.linkedTaskChildId
                                                                                  || task.linkedTaskParentId) {
                                                                                taskMap
                                                                                    .push({
                                                                                      locationId : key,
                                                                                      locationShiftId : shiftId,
                                                                                      shiftCategoryId : categoryId,
                                                                                      subcategoryTaskId : subId,
                                                                                      containsSections : <span class="hljs-literal">false</span>,
                                                                                      peoplePerTask : subs[subId].subcategory.peoplePerTask,
                                                                                      taskId : taskId,
                                                                                      sequence : task.sequence,
                                                                                      linkedTaskChildId : task.linkedTaskChildId,
                                                                                      linkedTaskParentId : task.linkedTaskParentId,
                                                                                    })
                                                                              }
                                                                            })
                                                                    subs[subId].numOfTasks = <span class="hljs-built_in">Object</span>
                                                                        .keys(subs[subId].tasks).length;
                                                                    subs[subId].hasTasks = <span class="hljs-literal">true</span>;
                                                                  }
                                                                })
                                                      }
                                                      <span class="hljs-keyword">break</span>;
                                                    }
                                                  }
                                              })
                                    }
                                  })
                        }
                      })

              <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">findNext</span><span class="hljs-params">(taskId)</span> </span>{
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; taskMap.length; i++)
                  <span class="hljs-keyword">if</span> (taskMap[i].taskId === taskId)
                    <span class="hljs-keyword">return</span> i;
                <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
              }
              <span class="hljs-keyword">var</span> headNodes = [];
              <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> k = <span class="hljs-number">0</span>; k &lt; taskMap.length; k++)
                <span class="hljs-keyword">if</span> (!taskMap[k].linkedTaskParentId)
                  headNodes.push(k)

              <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> z = <span class="hljs-number">0</span>; z &lt; headNodes.length; z++) {
                <span class="hljs-keyword">if</span> (!taskMap[headNodes[z]].groupId) {
                  taskMap[headNodes[z]].groupId = groupCnt.cnt++ % <span class="hljs-number">18</span>;
                  <span class="hljs-keyword">var</span> index = headNodes[z];
                  <span class="hljs-keyword">do</span> {
                    index = findNext(taskMap[index].linkedTaskChildId)
                    <span class="hljs-keyword">if</span> (index !== -<span class="hljs-number">1</span>)
                      taskMap[index].groupId = taskMap[headNodes[z]].groupId
                  } <span class="hljs-keyword">while</span> (taskMap[index] &amp;&amp; taskMap[index].linkedTaskChildId)
                }
              }

              <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j = <span class="hljs-number">1</span>; j &lt;= groupCnt.cnt; j++) {
                <span class="hljs-keyword">var</span> homogeneous = <span class="hljs-literal">true</span>, subcategoryTaskId = <span class="hljs-literal">null</span>;
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; taskMap.length; i++) {
                  <span class="hljs-keyword">if</span> (taskMap[i].groupId === j) {
                    <span class="hljs-keyword">if</span> (!subcategoryTaskId) {
                      subcategoryTaskId = taskMap[i].subcategoryTaskId;
                    }
                    <span class="hljs-keyword">if</span> (taskMap[i].subcategoryTaskId !== subcategoryTaskId) {
                      homogeneous = <span class="hljs-literal">false</span>;
                    }
                  }
                }
                <span class="hljs-keyword">if</span> (homogeneous) {
                  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; taskMap.length; i++) {
                    <span class="hljs-keyword">if</span> (taskMap[i].groupId === j) {
                      taskMap[i].homogeneous = <span class="hljs-literal">true</span>;
                    }
                  }
                }
              }
              <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j = <span class="hljs-number">0</span>; j &lt; taskMap.length; j++) {
                <span class="hljs-keyword">var</span> sub = data.locations[taskMap[j].locationId].locationShifts[taskMap[j].locationShiftId].shiftCategories[taskMap[j].shiftCategoryId].subcategoryTasks[taskMap[j].subcategoryTaskId];
                <span class="hljs-keyword">if</span> (sub.subcategory.containsSections) {
                  sub.sections[taskMap[j].sectionId].tasks[taskMap[j].taskId].groupId = taskMap[j].groupId;
                  sub.sections[taskMap[j].sectionId].tasks[taskMap[j].taskId].homogeneous = taskMap[j].homogeneous;
                } <span class="hljs-keyword">else</span> {
                  sub.tasks[taskMap[j].taskId].groupId = taskMap[j].groupId;
                  sub.tasks[taskMap[j].taskId].homogeneous = taskMap[j].homogeneous;
                }
              }

              <span class="hljs-keyword">return</span> data;
            }
          }
        })</div></div></div></div></body></html>